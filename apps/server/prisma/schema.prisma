// Prisma Schema for Linksnap
// 网页截图 API 服务

generator client {
  provider   = "prisma-client"
  output     = "../generated/prisma"
  outputType = "commonjs"
}

datasource db {
  provider = "postgresql"
}

// =============================================
// 用户系统（Better Auth 核心表）
// =============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  emailVerified Boolean   @default(false)
  image         String?
  isAdmin       Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime? // 软删除时间戳，null 表示未删除

  sessions              Session[]
  accounts              Account[]
  subscription          Subscription?
  quota                 Quota?
  apiKeys               ApiKey[]
  screenshots           Screenshot[]
  webhooks              Webhook[]
  accountDeletionRecord AccountDeletionRecord?
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Account {
  id                    String    @id @default(cuid())
  userId                String
  accountId             String
  providerId            String
  accessToken           String?
  refreshToken          String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@index([userId])
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
}

// =============================================
// 订阅系统
// =============================================

enum SubscriptionTier {
  FREE
  BASIC
  PRO
  TEAM
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  EXPIRED
}

model Subscription {
  id                  String             @id @default(cuid())
  userId              String             @unique
  tier                SubscriptionTier   @default(FREE)
  status              SubscriptionStatus @default(ACTIVE)
  creemCustomerId     String?
  creemSubscriptionId String?            @unique
  currentPeriodStart  DateTime           @default(now())
  currentPeriodEnd    DateTime?
  cancelAtPeriodEnd   Boolean            @default(false)
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// =============================================
// 配额系统
// =============================================

enum QuotaTransactionType {
  DEDUCT    // 扣减
  REFUND    // 返还
  PURCHASE  // 购买
  RESET     // 周期重置
}

enum QuotaSource {
  MONTHLY    // 月度配额
  PURCHASED  // 购买配额
}

model Quota {
  id             String   @id @default(cuid())
  userId         String   @unique

  // 月度订阅配额
  monthlyLimit   Int      @default(100)
  monthlyUsed    Int      @default(0)
  periodStartAt  DateTime @default(now())
  periodEndAt    DateTime

  // 按量购买额度（永不过期）
  purchasedQuota Int      @default(0)

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model QuotaTransaction {
  id            String               @id @default(cuid())
  userId        String
  type          QuotaTransactionType
  amount        Int                  // 正数
  source        QuotaSource
  balanceBefore Int
  balanceAfter  Int
  reason        String?              // screenshot_id 或其他说明
  createdAt     DateTime             @default(now())

  @@index([userId])
  @@index([createdAt])
}

// =============================================
// 支付订单
// =============================================

model PaymentOrder {
  id           String   @id @default(cuid())
  userId       String
  creemOrderId String   @unique
  type         String   // subscription | quota_purchase
  amount       Int      // 金额（分）
  currency     String   @default("USD")
  status       String   // pending | completed | failed | refunded
  quotaAmount  Int?     // 购买的配额数量（按量购买时）
  metadata     Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
}

// =============================================
// API Key
// =============================================

model ApiKey {
  id         String    @id @default(cuid())
  userId     String
  name       String
  keyPrefix  String    // 展示用，如 "lk_abc1"
  keyHash    String    @unique // SHA256(完整key)
  isActive   Boolean   @default(true)
  lastUsedAt DateTime?
  expiresAt  DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  screenshots Screenshot[]

  @@index([userId])
  @@index([keyHash])
}

// =============================================
// 截图记录
// =============================================

enum ScreenshotStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model Screenshot {
  id          String           @id @default(cuid())
  userId      String
  apiKeyId    String?

  // 请求信息
  url         String
  requestHash String
  request     Json

  // 配额追踪
  quotaDeducted Boolean      @default(false)
  quotaSource   QuotaSource?

  // 处理结果
  status        ScreenshotStatus @default(PENDING)
  fileUrl       String?
  fileSize      Int?
  fileExpiresAt DateTime?
  error         String?

  // 页面元信息
  pageTitle   String?
  pageDesc    String?
  pageFavicon String?

  // 性能
  processingMs   Int?
  fromCache      Boolean        @default(false)

  // 时间统计（各阶段耗时）
  queueWaitMs    Int?           // 队列等待时间
  pageLoadMs     Int?           // 页面加载时间
  captureMs      Int?           // 截图捕获时间
  imageProcessMs Int?           // 图片处理时间
  uploadMs       Int?           // 文件上传时间

  // 时间
  createdAt   DateTime        @default(now())
  completedAt DateTime?

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  apiKey ApiKey? @relation(fields: [apiKeyId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([url])
  @@index([requestHash])
  @@index([status])
  @@index([createdAt])
  @@index([fileExpiresAt])
}

// =============================================
// Webhook 配置
// =============================================

model Webhook {
  id        String   @id @default(cuid())
  userId    String
  name      String
  url       String
  secret    String
  events    String[] @default(["screenshot.completed", "screenshot.failed"])
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user       User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  deliveries WebhookDelivery[]

  @@index([userId])
}

model WebhookDelivery {
  id          String    @id @default(cuid())
  webhookId   String
  event       String
  payload     Json
  statusCode  Int?
  response    String?
  error       String?
  attempts    Int       @default(1)
  success     Boolean   @default(false)
  latencyMs   Int?
  createdAt   DateTime  @default(now())
  deliveredAt DateTime?

  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([createdAt])
}

// =============================================
// 账户删除记录
// =============================================

model AccountDeletionRecord {
  id        String   @id @default(cuid())
  userId    String   @unique
  email     String   // 删除时的邮箱（保留用于记录）
  reason    String   // 删除原因代码
  feedback  String?  // 用户可选的详细反馈
  deletedAt DateTime @default(now()) // 删除时间

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([reason])
  @@index([deletedAt])
}
